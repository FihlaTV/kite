<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  
  <title>Visual Shape Test</title>
  
  <script src="../contrib/lodash.min-1.0.0-rc.3.js"></script>
  <script src="../contrib/has.js"></script>
  
  <script data-main="../js/config.js" src="../contrib/require-2.1.4.js"></script>
  
  <style>
    html, body {
      margin: 0;
      padding: 0;
    }
    
    canvas {
      position: absolute;
      left: 0;
      top: 0;
    }
    
    div#controls {
      width: 200px;
      /*height: 400px;*/
      position: absolute;
      right: 0;
      top: 0;
      background-color: #eee;
      border-left: 1px solid black;
      border-bottom: 1px solid black;
    }
    
    .label {
      text-align: center;
    }
    
    input {
      display: block;
      margin: 0 auto;
    }
  </style>
  
</head>
<body>
  <canvas id="canvas"></canvas>
  
  <div id="controls">
    <div class="label">Basic Segments</div>
    <button id="line">line</button>
    <button id="quadratic">quadratic</button>
    <button id="cubic">cubic</button>
    <button id="arc">arc</button>
    <button id="ellipticalArc">ellipticalArc</button>
    
    <div class="label">Shapes</div>
    <button id="lines">lines</button>
    <button id="arc1">arc1</button>
    <button id="arc2">arc2</button>
    <button id="arc3">arc3</button>
    <button id="arc4">arc4</button>
    
    <div class="label">Cap</div>
    <button id="cap-butt">butt</button>
    <button id="cap-square">square</button>
    <button id="cap-round">round</button>
    
    <div class="label">Join</div>
    <button id="join-miter">miter</button>
    <button id="join-bevel">bevel</button>
    <button id="join-round">round</button>
    
    <div class="label">Point</div>
    <input id="point" type="range" min="0" max="1" step = "0.01" value="0"/>
    <button id="point-position">position</button>
    <button id="point-tangent">tangent</button>
    <button id="point-curvature">curvature</button>
  </div>
  
  <script>
    // we need to wait until our config file is loaded before our require statement. apparently this was not guaranteed
    function check() {
      if ( window.loadedKiteConfig ) {
        require( [ 'main', 'DOT/main' ], function( kite, dot ) {
          window.kite = kite;
          window.dot = dot;
          
          console.log( 'loaded' );
          
          /*---------------------------------------------------------------------------*
           * State
           *---------------------------------------------------------------------------*/
          var strokeStyles = {
            width: 30,
            cap: 'butt',
            join: 'miter',
            miterLimit: 10
          };
          
          var point = 0; // how far our inspection point is along the curve
          var pointPosition = false; // highlight the inspected point(s)
          var pointTangent = false; // tangent on points
          var pointCurvature = false; // curvature on points
          
          var shape = new kite.Shape();
          
          /*---------------------------------------------------------------------------*
           * Drawing
           *---------------------------------------------------------------------------*/
          var canvas = document.getElementById( 'canvas' );
          window.canvas = canvas;
          
          var context = canvas.getContext( '2d' );
          window.context = context;
          
          canvas.width = window.innerWidth;
          canvas.height = window.innerHeight;
          
          function render() {
            context.clearRect( 0, 0, canvas.width, canvas.height );
            context.beginPath();
            shape.writeToContext( context );
            
            // main shape stroked in black
            context.strokeStyle = '#000';
            context.lineWidth = strokeStyles.width;
            context.lineCap = strokeStyles.cap;
            context.lineJoin = strokeStyles.join;
            context.miterLimit = strokeStyles.miterLimit;
            context.stroke();
            
            // overlay in red
            context.strokeStyle = '#f00';
            context.lineWidth = 1;
            context.lineCap = 'butt';
            context.lineJoin = 'miter';
            context.miterLimit = 10;
            context.stroke();
            
            _.each( shape.subpaths, function( subpath ) {
              _.each( subpath.segments, function( segment ) {
                var p = segment.positionAt( point );
                var t = segment.tangentAt( point );
                var tn = t.normalized();
                var c = segment.curvatureAt( point );
                
                console.log( 'point: ' + p.toString() );
                console.log( 'tangent: ' + tn.toString() );
                console.log( 'curvature: ' + c );
                
                // highlight the inspection point
                if ( pointPosition ) {
                  context.beginPath();
                  context.arc( p.x, p.y, 3, 0, Math.PI * 2, false );
                  context.fillStyle = '#0f0';
                  context.fill();
                }
                
                if ( pointTangent ) {
                  var length = 15;
                  context.beginPath();
                  context.moveTo( p.x - tn.x * length, p.y - tn.y * length );
                  context.lineTo( p.x + tn.x * length, p.y + tn.y * length );
                  context.strokeStyle = '#0ff';
                  context.lineWidth = 1;
                  context.stroke();
                }
                
                if ( pointCurvature ) {
                  if ( Math.abs( c ) > 0.0000001 ) {
                    var radiusOfCurvature = 1 / c;
                    var curvatureCenter = p.plus( tn.perpendicular().times( radiusOfCurvature ) );
                    
                    context.beginPath();
                    context.arc( curvatureCenter.x, curvatureCenter.y, Math.abs( radiusOfCurvature ), 0, Math.PI * 2, false );
                    context.fillStyle = '#f0f';
                    context.lineWidth = 1;
                    context.stroke();
                  }
                }
                
              } );
            } );
          }
          
          function updateListener( id, callback, event ) {
            event = event || 'click';
            document.getElementById( id ).addEventListener( event, function() {
              callback();
              render();
            } );
          }
          
          /*---------------------------------------------------------------------------*
          * Basic segments
          *----------------------------------------------------------------------------*/
          updateListener( 'line', function() {
            shape = new kite.Shape().moveTo( 50, 50 ).lineTo( 100, 200 );
          } );
          updateListener( 'quadratic', function() {
            shape = new kite.Shape().moveTo( 50, 50 ).quadraticCurveTo( 100, 200, 200, 200 );
          } );
          updateListener( 'cubic', function() {
            shape = new kite.Shape().moveTo( 50, 50 ).cubicCurveTo( 100, 200, 200, 200, 150, 250 );
          } );
          updateListener( 'arc', function() {
            shape = new kite.Shape().arc( 150, 150, 100, Math.PI / 4, -Math.PI / 2, false );
          } );
          updateListener( 'ellipticalArc', function() {
            shape = new kite.Shape().ellipticalArc( 150, 150, 100, 50, Math.PI / 4, Math.PI / 4, -Math.PI / 2, false );
          } );
          
          /*---------------------------------------------------------------------------*
          * Shapes
          *----------------------------------------------------------------------------*/
          
          updateListener( 'lines', function() {
            shape = new kite.Shape().moveTo( 50, 50 ).lineTo( 100, 200 ).lineTo( 200, 200 ).lineTo( 150, 150 );
          } );
          updateListener( 'arc1', function() {
            shape = new kite.Shape().arc( 150, 150, 100, Math.PI / 4, -Math.PI / 2, false );
          } );
          updateListener( 'arc2', function() {
            shape = new kite.Shape().arc( 150, 150, 100, Math.PI / 4, -Math.PI / 2, true );
          } );
          updateListener( 'arc3', function() {
            shape = new kite.Shape().arc( 150, 150, 100, -Math.PI / 4, Math.PI / 2, false );
          } );
          updateListener( 'arc4', function() {
            shape = new kite.Shape().arc( 150, 150, 100, -Math.PI / 4, Math.PI / 2, true );
          } );
          
          /*---------------------------------------------------------------------------*
          * Line Cap
          *----------------------------------------------------------------------------*/
          
          updateListener( 'cap-butt', function() {
            strokeStyles.cap = 'butt';
          } );
          updateListener( 'cap-square', function() {
            strokeStyles.cap = 'square';
          } );
          updateListener( 'cap-round', function() {
            strokeStyles.cap = 'round';
          } );
          
          /*---------------------------------------------------------------------------*
          * Line Join
          *----------------------------------------------------------------------------*/
          
          updateListener( 'join-miter', function() {
            strokeStyles.join = 'miter';
          } );
          updateListener( 'join-bevel', function() {
            strokeStyles.join = 'bevel';
          } );
          updateListener( 'join-round', function() {
            strokeStyles.join = 'round';
          } );
          
          /*---------------------------------------------------------------------------*
          * Point
          *----------------------------------------------------------------------------*/
          
          updateListener( 'point', function() {
            point = document.getElementById( 'point' ).value;
          }, 'input' );
          
          updateListener( 'point-position', function() {
            pointPosition = !pointPosition;
          } );
          updateListener( 'point-tangent', function() {
            pointTangent = !pointTangent;
          } );
          updateListener( 'point-curvature', function() {
            pointCurvature = !pointCurvature;
          } );
          
          // var lastTime = 0;
          // var timeElapsed = 0;
          // function tick() {
          //   window.requestAnimationFrame( tick, main[0] );
            
          //   var timeNow = new Date().getTime();
          //   if ( lastTime != 0 ) {
          //     timeElapsed = (timeNow - lastTime) / 1000.0;
          //   }
          //   lastTime = timeNow;
            
            
          // }
          // window.requestAnimationFrame( tick, main[0] );
        } );
      } else {
        setTimeout( check, 4 );
      }
    }
    setTimeout( check, 4 );
  </script>
</body>
</html>
