<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  
  <title>Visual Shape Test</title>
  
  <script src="../contrib/lodash.min-1.0.0-rc.3.js"></script>
  <script src="../contrib/has.js"></script>
  
  <script data-main="../js/config.js" src="../contrib/require-2.1.4.js"></script>
  
  <style>
    html, body {
      margin: 0;
      padding: 0;
    }
    
    canvas {
      position: absolute;
      left: 0;
      top: 0;
    }
    
    div#controls {
      width: 200px;
      /*height: 400px;*/
      position: absolute;
      right: 0;
      top: 0;
      background-color: #eee;
      border-left: 1px solid black;
      border-bottom: 1px solid black;
    }
    
    .label {
      text-align: center;
    }
    
    input {
      display: block;
      margin: 0 auto;
    }
  </style>
  
</head>
<body>
  <canvas id="canvas"></canvas>
  
  <div id="controls">
    <!-- TODO: handle like radio buttons -->
    <div class="label">Basic Segments</div>
    <button id="line">line</button>
    <button id="quadratic">quadratic</button>
    <button id="cubic">cubic</button>
    <button id="arc">arc</button>
    <button id="ellipticalArc">ellipticalArc</button>
    
    <div class="label">Shapes</div>
    <button id="lines">lines</button>
    <button id="arc1">arc1</button>
    <button id="arc2">arc2</button>
    <button id="arc3">arc3</button>
    <button id="arc4">arc4</button>
    
    <div class="label">Cap</div>
    <button id="cap-butt">butt</button>
    <button id="cap-square">square</button>
    <button id="cap-round">round</button>
    
    <div class="label">Join</div>
    <button id="join-miter">miter</button>
    <button id="join-bevel">bevel</button>
    <button id="join-round">round</button>
    
    <div class="label">Close</div>
    <button id="close">close</button>
    
    <div class="label">Point</div>
    <input id="point" type="range" min="0" max="1" step="0.01" value="0"/>
    <button id="point-position">position</button>
    <button id="point-tangent">tangent</button>
    <button id="point-curvature">curvature</button>
    
    <div class="label">Bounds</div>
    <button id="bounds-shape">shape</button>
    
    <div class="label">Fill</div>
    <button id="fill">fill</button>
    
    <div class="label">Stroke</div>
    <button id="stroke-canvas">canvas</button>
    <button id="stroke-kite">kite</button>
    
    <div class="label">Transform</div>
    <button id="transform-active">active</button>
    <button id="transform-reflect">reflect</button>
    <input id="translation" type="range" min="-50" max="50" step="1" value="0"/>
    <input id="rotation" type="range" min="-180" max="180" step="1" value="0"/>
    <input id="scaling" type="range" min="0.5" max="1.5" step="0.01" value="1"/>
    <input id="shear" type="range" min="-2" max="2" step="0.01" value="0"/>
    
    <div class="label">Hit test</div>
    <button id="hit-fill">fill</button>
    <button id="hit-stroke">stroke</button>
  </div>
  
  <script>
    // we need to wait until our config file is loaded before our require statement. apparently this was not guaranteed
    function check() {
      if ( window.loadedKiteConfig ) {
        require( [ 'main', 'DOT/main' ], function( kite, dot ) {
          window.kite = kite;
          window.dot = dot;
          
          console.log( 'loaded' );
          
          /*---------------------------------------------------------------------------*
           * State
           *---------------------------------------------------------------------------*/
          
          var strokeStyles = new kite.LineStyles( {
            lineWidth: 30,
            lineCap: 'butt',
            lineJoin: 'miter',
            miterLimit: 10
          } );
          
          var point = 0; // how far our inspection point is along the curve
          var pointPosition = false; // highlight the inspected point(s)
          var pointTangent = false; // tangent on points
          var pointCurvature = false; // curvature on points
          
          var kiteStroked = false;
          var fill = false;
          var close = false;
          
          var shapeBounds = false;
          
          var shape = new kite.Shape();
          
          var xOffset = 150;
          var yOffset = 150;
          
          var transformActive = false;
          var translation = 0;
          var rotation = 0;
          var scaling = 1;
          var shear = 0;
          var reflection = false;
          
          /*---------------------------------------------------------------------------*
           * Drawing
           *---------------------------------------------------------------------------*/
          var canvas = document.getElementById( 'canvas' );
          window.canvas = canvas;
          
          var context = canvas.getContext( '2d' );
          window.context = context;
          
          canvas.width = window.innerWidth;
          canvas.height = window.innerHeight;
          
          function render() {
            context.setTransform( 1, 0, 0, 1, 0, 0 );
            context.clearRect( 0, 0, canvas.width, canvas.height );
            context.setTransform( 1, 0, 0, 1, xOffset, yOffset );
            
            var transformedShape = shape;
            if ( transformActive ) {
              var matrix = dot.Matrix3.translation( translation, 0 )
                          .timesMatrix( dot.Matrix3.rotation2( rotation ) )
                          .timesMatrix( dot.Matrix3.scale( scaling ) )
                          .timesMatrix( new dot.Matrix3( 1, shear, 0, 0, 1, 0, 0, 0, 1 ) )
                          .timesMatrix( reflection ? dot.Matrix3.X_REFLECTION : dot.Matrix3.IDENTITY );
              transformedShape = shape.transformed( matrix );
              console.log( matrix.toString() + '\n' );
            }
            if ( close ) {
              transformedShape = new kite.Shape( transformedShape.pieces, true );
            }
            
            // main shape stroked in black
            context.beginPath();
            if ( kiteStroked ) {
              transformedShape.getStrokedShape( strokeStyles ).writeToContext( context );
              context.fillStype = '#000';
              context.fill();
            } else {
              transformedShape.writeToContext( context );
              context.strokeStyle = '#000';
              context.lineWidth = strokeStyles.lineWidth;
              context.lineCap = strokeStyles.lineCap;
              context.lineJoin = strokeStyles.lineJoin;
              context.miterLimit = strokeStyles.miterLimit;
              context.stroke();
            }
            
            // overlay in red
            context.beginPath();
            transformedShape.writeToContext( context );
            context.strokeStyle = '#f00';
            context.lineWidth = 1;
            context.lineCap = 'butt';
            context.lineJoin = 'miter';
            context.miterLimit = 10;
            context.stroke();
            
            _.each( transformedShape.subpaths, function( subpath ) {
              _.each( subpath.segments, function( segment ) {
                var p = segment.positionAt( point );
                var t = segment.tangentAt( point );
                var tn = t.normalized();
                var c = segment.curvatureAt( point );
                
                console.log( 'point: ' + p.toString() );
                console.log( 'tangent: ' + tn.toString() );
                console.log( 'curvature: ' + c );
                
                // highlight the inspection point
                if ( pointPosition ) {
                  context.beginPath();
                  context.arc( p.x, p.y, 3, 0, Math.PI * 2, false );
                  context.fillStyle = '#0f0';
                  context.fill();
                }
                
                if ( pointTangent ) {
                  var length = 15;
                  context.beginPath();
                  context.moveTo( p.x - tn.x * length, p.y - tn.y * length );
                  context.lineTo( p.x + tn.x * length, p.y + tn.y * length );
                  context.strokeStyle = '#0ff';
                  context.lineWidth = 1;
                  context.stroke();
                }
                
                if ( pointCurvature ) {
                  if ( Math.abs( c ) > 0.0000001 ) {
                    var radiusOfCurvature = 1 / c;
                    var curvatureCenter = p.plus( tn.perpendicular().times( radiusOfCurvature ) );
                    
                    context.beginPath();
                    context.arc( curvatureCenter.x, curvatureCenter.y, Math.abs( radiusOfCurvature ), 0, Math.PI * 2, false );
                    context.fillStyle = '#f0f';
                    context.lineWidth = 1;
                    context.stroke();
                  }
                }                
              } );
            } );
            
            if ( shapeBounds ) {
              var b = kiteStroked ? transformedShape.getStrokedShape( strokeStyles ).bounds : transformedShape.bounds;
              context.beginPath();
              context.rect( b.minX, b.minY, b.width, b.height );
              context.strokeStyle = 'rgba(255,0,255,0.8)';
              context.lineWidth = 1;
              context.stroke();
            }
            
            if ( fill ) {
              context.beginPath();
              transformedShape.writeToContext( context );
              context.fillStyle = 'rgba(255,255,0,0.5)';
              context.fill();
            }
          }
          
          function updateListener( id, callback, event ) {
            event = event || 'click';
            document.getElementById( id ).addEventListener( event, function() {
              callback();
              render();
            } );
          }
          
          /*---------------------------------------------------------------------------*
          * Basic segments
          *----------------------------------------------------------------------------*/
          updateListener( 'line', function() {
            shape = new kite.Shape().moveTo( -100, -100 ).lineTo( -50, 50 );
          } );
          updateListener( 'quadratic', function() {
            shape = new kite.Shape().moveTo( -100, -100 ).quadraticCurveTo( -50, 50, 50, 50 );
          } );
          updateListener( 'cubic', function() {
            shape = new kite.Shape().moveTo( -100, -100 ).cubicCurveTo( -50, 50, 50, 50, 0, 100 );
          } );
          updateListener( 'arc', function() {
            shape = new kite.Shape().arc( 0, 0, 100, Math.PI / 4, -Math.PI / 2, false );
          } );
          updateListener( 'ellipticalArc', function() {
            shape = new kite.Shape().ellipticalArc( 0, 0, 100, 50, Math.PI / 4, Math.PI / 4, -Math.PI / 2, false );
          } );
          
          /*---------------------------------------------------------------------------*
          * Shapes
          *----------------------------------------------------------------------------*/
          
          updateListener( 'lines', function() {
            shape = new kite.Shape().moveTo( -100, -100 ).lineTo( -50, 50 ).lineTo( 50, 50 ).lineTo( 30, 0 );
          } );
          updateListener( 'arc1', function() {
            shape = new kite.Shape().arc( 0, 0, 100, Math.PI / 4, -Math.PI / 2, false );
          } );
          updateListener( 'arc2', function() {
            shape = new kite.Shape().arc( 0, 0, 100, Math.PI / 4, -Math.PI / 2, true );
          } );
          updateListener( 'arc3', function() {
            shape = new kite.Shape().arc( 0, 0, 100, -Math.PI / 4, Math.PI / 2, false );
          } );
          updateListener( 'arc4', function() {
            shape = new kite.Shape().arc( 0, 0, 100, -Math.PI / 4, Math.PI / 2, true );
          } );
          
          /*---------------------------------------------------------------------------*
          * Line Cap
          *----------------------------------------------------------------------------*/
          
          updateListener( 'cap-butt', function() {
            strokeStyles.lineCap = 'butt';
          } );
          updateListener( 'cap-square', function() {
            strokeStyles.lineCap = 'square';
          } );
          updateListener( 'cap-round', function() {
            strokeStyles.lineCap = 'round';
          } );
          
          /*---------------------------------------------------------------------------*
          * Line Join
          *----------------------------------------------------------------------------*/
          
          updateListener( 'join-miter', function() {
            strokeStyles.lineJoin = 'miter';
          } );
          updateListener( 'join-bevel', function() {
            strokeStyles.lineJoin = 'bevel';
          } );
          updateListener( 'join-round', function() {
            strokeStyles.lineJoin = 'round';
          } );
          
          /*---------------------------------------------------------------------------*
          * Close
          *----------------------------------------------------------------------------*/
          
          updateListener( 'close', function() {
            close = !close;
          } );
          
          /*---------------------------------------------------------------------------*
          * Point
          *----------------------------------------------------------------------------*/
          
          updateListener( 'point', function() {
            point = document.getElementById( 'point' ).value;
          }, 'input' );
          
          updateListener( 'point-position', function() {
            pointPosition = !pointPosition;
          } );
          updateListener( 'point-tangent', function() {
            pointTangent = !pointTangent;
          } );
          updateListener( 'point-curvature', function() {
            pointCurvature = !pointCurvature;
          } );
          
          /*---------------------------------------------------------------------------*
          * Bounds
          *----------------------------------------------------------------------------*/
          
          updateListener( 'bounds-shape', function() {
            shapeBounds = !shapeBounds;
          } );
          
          /*---------------------------------------------------------------------------*
          * Fill
          *----------------------------------------------------------------------------*/
          
          updateListener( 'fill', function() {
            fill = !fill;
          } );
          
          /*---------------------------------------------------------------------------*
          * Stroke
          *----------------------------------------------------------------------------*/
          
          updateListener( 'stroke-canvas', function() {
            kiteStroked = false;
          } );
          updateListener( 'stroke-kite', function() {
            kiteStroked = true;
          } );
          
          /*---------------------------------------------------------------------------*
          * Transform
          *----------------------------------------------------------------------------*/
          
          updateListener( 'transform-active', function() {
            transformActive = !transformActive;
          } );
          updateListener( 'transform-reflect', function() {
            reflection = !reflection;
          } );
          updateListener( 'translation', function() {
            translation = parseFloat( document.getElementById( 'translation' ).value );
          }, 'input' );
          updateListener( 'rotation', function() {
            rotation = parseFloat( document.getElementById( 'rotation' ).value ) * Math.PI / 180;
          }, 'input' );
          updateListener( 'scaling', function() {
            scaling = parseFloat( document.getElementById( 'scaling' ).value );
          }, 'input' );
          updateListener( 'shear', function() {
            shear = parseFloat( document.getElementById( 'shear' ).value );
          }, 'input' );
          
          /*---------------------------------------------------------------------------*
          * Hit testing
          *----------------------------------------------------------------------------*/
          
          document.getElementById( 'hit-fill' ).addEventListener( 'click', function() {
            
          } );
          
          document.getElementById( 'hit-stroke' ).addEventListener( 'click', function() {
            
          } );
          
          // var lastTime = 0;
          // var timeElapsed = 0;
          // function tick() {
          //   window.requestAnimationFrame( tick, main[0] );
            
          //   var timeNow = new Date().getTime();
          //   if ( lastTime != 0 ) {
          //     timeElapsed = (timeNow - lastTime) / 1000.0;
          //   }
          //   lastTime = timeNow;
            
            
          // }
          // window.requestAnimationFrame( tick, main[0] );
        } );
      } else {
        setTimeout( check, 4 );
      }
    }
    setTimeout( check, 4 );
  </script>
</body>
</html>
